<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/lib/revealjs/reveal.css" />
    <link rel="stylesheet" href="/lib/revealjs/theme/moon.css" />
    <link rel="stylesheet" href="/lib/revealjs/plugins/highlight/zenburn.css" />
    <link rel="stylesheet" href="/assets/styles/default.css" />

    <script src="/socket.io/socket.io.js" lang="javascript"></script>
    <script src="/lib/revealjs/reveal.js" lang="javascript"></script>
    <script src="/lib/revealjs/plugins/highlight/highlight.js" lang="javascript"></script>
    <script src="/lib/revealjs/plugins/markdown/markdown.js" lang="javascript"></script>
    <script src="/lib/revealjs/plugins/mermaid/mermaid.js" lang="javascript"></script>
    <script src="/lib/revealjs/plugins/notes/notes.js" lang="javascript"></script>
    <script src="/assets/scripts/index.js" lang="javascript"></script>

    <title>Intro to MongoDB</title>
</head>

<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <div class="title-slide">
                    <div class="hero-image">
                        <img src="./assets/images/title.jpg">
                    </div>

                    <div class="title-content">
                        <h2 class="fragment semi-fade-out">Intro to MongoDB</h2>
                        <h4 class="fragment fade-down">Things I wish I knew 5 years ago</h4>

                        <p style="font-size: 0.5em">
                            Dave Fancher<br />
                            Lead Software Engineer<br />
                            Vibenomics, A Mood Media Company
                        </p>
                        <hr />
                        <p style="font-size: 0.5em; margin-bottom: 1.5em;">
                            Twitter: @davefancher<br />
                            LinkedIn: davefancher
                        </p>
                    </div>
                </div>

                <div class="footnote">Base cover image generated by Microsoft Bing search chat;
                    Edited in Affinity Photo 2</div>
            </section>

            <section>
                <h2>About this Presentation</h2>
                <ul>
                    <li class="fragment">Not intended to be comprehensive</li>
                    <li class="fragment">Discussion of useful MongoDB concepts</li>
                    <li class="fragment">Focusing on the database, not Atlas</li>
                    <li class="fragment">Sticking as close to <code class="javascript">mongosh</code> as possible</li>
                    <li class="fragment">Examples use the Sample Mflix Dataset provided by MongoDB unless otherwise stated</li>
                </ul>
            </section>

            <section>
                <section>
                    <h2>What is MongoDB?</h2>

                    <ul>
                        <li class="fragment">NoSQL database</li>
                        <li class="fragment">Broad support across most ecosystems</li>
                        <li class="fragment">
                            <span class="fragment strike semi-fade-out">Tables & Rows</span>
                            <span class="fragment fade-in">Collections & Documents</span>
                        </li>
                        <li class="fragment">
                            <span class="fragment strike semi-fade-out">Schemaless</span>
                            <span class="fragment fade-in">Flexible schema</span>
                        </li>
                        <li class="fragment">
                            <span class="fragment strike semi-fade-out">Non-relational</span>
                            <span class="fragment fade-in">All data is relational</span>
                        </li>
                    </ul>
                </section>

                <section>
                    <h3>NoSQL Database</h3>

                    <ul>
                        <li class="fragment">Doesn't use SQL</li>
                        <li class="fragment">Query API</li>
                        <li class="fragment">JSON-like language</li>
                        <li class="fragment">Defines standard CRUD operations</li>
                        <li class="fragment">Defines schema manipulation operations</li>
                        <li class="fragment">Aggregation pipelines</li>
                    </ul>
                </section>

                <section>
                    <h3>Broad Availability</h3>

                    <div class="two-column-text">
                        <div class="fragment">
                            <p>Native Drivers</p>
                            <ul class="fragment">
                                <li>Node.js</li>
                                <li>.NET</li>
                                <li>C++</li>
                                <li>Go</li>
                                <li>Java</li>
                                <li>Python</li>
                                <li>Rust</li>
                                <li>...</li>
                            </ul>
                        </div>

                        <div>
                            <p class="fragment">Hosting</p>
                            <ul class="fragment">
                                <li>Self (Install or Docker)</li>
                                <li>Atlas</li>
                            </ul>

                            <p class="fragment">1st Party Tools</p>
                            <ul class="fragment">
                                <li>Atlas</li>
                                <li>Compass</li>
                                <li>VS Code Extension</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Collections</h3>

                    <ul>
                        <li class="fragment">Collections ~= Tables</li>
                        <li class="fragment">Hold documents</li>
                        <li class="fragment">Can often be created automatically</li>
                        <li class="fragment">Indexable</li>
                        <li class="fragment">Validatable</li>
                    </ul>
                </section>

                <section>
                    <h3>Documents</h3>

                    <ul>
                        <li class="fragment">Documents are groups of key/value pairs</li>
                        <li class="fragment">Documents may be nested</li>
                        <li class="fragment">Highly compatible with objects</li>
                        <li class="fragment">BSON format</li>
                    </ul>
                </section>

                <section>
                    <h3>BSON</h3>

                    <ul>
                        <li>Binary JSON</li>
                        <li>Encodes type and length information for faster traversal</li>
                        <li>Adds support for dates, binary data, multiple numeric formats, ObjectID, and so on</li>
                        <li>Flexible like JSON</li>
                    </ul>
                </section>

                <section>
                    <h4>Document Example</h4>

                    <pre>
                        <code class="javascript" data-trim data-noescape data-line-numbers="1-19|2-4|5|6-8|9,11,12,13|14-18">
                            {
                                "_id": {
                                    "$oid": "573a13ebf29313caabdd043e"
                                },
                                "title": "What We Do in the Shadows",
                                "released": {
                                    "$date": "2015-02-13T00:00:00Z"
                                }
                                "genres": [ "Comedy", "Horror" ],
                                "rated": "R",
                                "cast": [ "Jemaine Clement", "Taika Waititi" /* , ... */ ],
                                "directors": [ "Jemaine Clement", "Taika Waititi" ],
                                "languages": [ "English", "German", "Spanish" ],
                                "imdb": {
                                    "rating": 7.6,
                                    "votes": 41029,
                                    "id": 3416742
                                }
                              }
                        </code>
                    </pre>
                </section>

                <section>
                    <h3>Flexible Schema</h3>

                    <ul>
                        <li class="fragment">Document structure matters</li>
                        <li class="fragment">...but can easily evolve as needs change</li>
                        <li class="fragment">Different and evolving structures may coexist</li>
                        <li class="fragment">Optional schema validation allows can enforce more rigid structures</li>
                    </ul>
                </section>

                <section>
                    <h4>Flexible Schema Example</h4>

                    <pre>
                        <code class="javascript" data-trim data-noescape data-line-numbers>
                            [
                                {
                                    "_id": { "$oid": "573a13acf29313caabd289b3" },
                                    "title": "Anchorman: The Legend of Ron Burgundy",
                                    "year": 2004,
                                    "runtime": 94
                                },
                                {
                                    "_id": { "$oid": "573a13b1f29313caabd35ef4" },
                                    "title": "Talladega Nights: The Ballad of Ricky Bobby",
                                    "imdb_id": "tt0415306"
                                    "release_year": 2006
                                    "runtime_minutes": 108
                                  }
                            ]
                        </code>
                    </pre>
                </section>

                <section>
                    <h3>Relationships</h3>

                    <ul>
                        <li class="fragment">All Data is Relational</li>
                        <li class="fragment">
                            Two approaches
                            <ul>
                                <li>Embedded</li>
                                <li>Reference</li>
                            </ul>
                        </li>
                    </ul>
                </section>

                <section>
                    <h4>Visualizing Relationships</h4>

                    <div class="mermaid">
                        <pre>
                            %%{init: {'theme': 'default', 'themeVariables': { 'fontFamily': 'consolas' }}}%%
                            erDiagram
                                MOVIES ||--o{ COMMENTS : has
                                MOVIES {
                                    objectid _id PK
                                    string title
                                    string[] cast "Embedded relationship"
                                    string[] directors "Embedded relationship"
                                    object imdb "Embedded relationship"
                                    int num_mflix_comments
                                }

                                COMMENTS {
                                    objectid _id PK
                                    objectid movie_id FK "Reference relationship"
                                    string name
                                    string email
                                    date date
                                    string text
                                }
                        </pre>
                    </div>
                </section>
            </section>

            <section>
                <section>
                    <h2>Working with Data</h2>

                    <ul>
                        <li>Query API</li>
                        <li>Querying data</li>
                        <li>Inserting data</li>
                        <li>Modifying data</li>
                        <li>Deleting data</li>
                    </ul>
                </section>

                <section>
                    <h3>Query API</h3>

                    <ul>
                        <li>Formerly MongoDB Query Language (MQL)</li>
                        <li>The primary way we interact with our database</li>
                        <li>Defines CRUD operations</li>
                        <li>Bulk writes</li>
                        <li>Geospatial queries</li>
                    </ul>
                </section>

                <section>
                    <h3>Querying Data - findOne</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-16|1,2|3-16|4|5-16">
                                    db
                                        .getCollection("movies")
                                        .findOne(
                                            { title: /What we do in the shadows/i },
                                            {
                                                projection: {
                                                    _id: 1,
                                                    title: 1,
                                                    rated: 1,
                                                    languages: 1,
                                                    directors: 1,
                                                    cast: 1,
                                                    genres: 1,
                                                    imdb: 1
                                                }
                                            });
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="findOne_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="findOne">Clear</button>
                            <button class="runDemoButton" data-demo-name="findOne">Run</button>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Inserting Data</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-19|3|4-19">
                                    db
                                        .getCollection("movies")
                                        .insertOne(
                                            {
                                                title: "Jac Kessler's Popsy",
                                                rated: "R",
                                                languages: [ "English" ],
                                                directors: [ "Jac Kessler" ],
                                                cast: [
                                                    "Alex Dunning",
                                                    "Nadia Fancher",
                                                    "Ted Raimi"
                                                ],
                                                genres: [
                                                    "Short",
                                                    "Horror",
                                                    "Thriller"
                                                ]
                                            });
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="insertOne_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="insertOne">Clear</button>
                            <button class="runDemoButton" data-demo-name="insertOne">Run</button>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Updating Data</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-13|3-13|4|5-13">
                                    db
                                        .getCollection("movies")
                                        .updateOne(
                                            { title: "Jac Kessler's Popsy" },
                                            {
                                                $set: {
                                                    released: new Date("2019-09-08T00:00:00Z")
                                                },
                                                $push: {
                                                    genres: "Student",
                                                    languages: "Spanish"
                                                }
                                            });
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="updateOne_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="updateOne">Clear</button>
                            <button class="runDemoButton" data-demo-name="updateOne">Run</button>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Deleting Data</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-5|3-5|4">
                                    db
                                        .getCollection("movies")
                                        .deleteOne(
                                            { title: "Jac Kessler's Popsy" }
                                        );
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="deleteOne_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="deleteOne">Clear</button>
                            <button class="runDemoButton" data-demo-name="deleteOne">Run</button>
                        </div>
                    </div>
                </section>
            </section>

            <section>
                <section>
                    <h2>Aggregation Pipelines</h2>

                    <ul>
                        <li class="fragment">Alternative way to query data</li>
                        <li class="fragment">Pipeline pattern</li>
                        <li class="fragment">Significantly more powerful</li>
                        <li class="fragment">Data from one stage flows to the next</li>
                        <li class="fragment">"Queryland" vs "Aggregationland"</li>
                    </ul>
                </section>

                <section>
                    <h3>Common Stages</h3>

                    <div class="two-column-text">
                        <div>
                            <ul>
                                <li>$match</li>
                                <li>$project</li>
                                <li>$set</li>
                                <li>$unset</li>
                                <li>$group</li>
                            </ul>
                        </div>

                        <div>
                            <ul>
                                <li>$sort</li>
                                <li>$lookup</li>
                                <li>$limit</li>
                                <li>$unwind</li>
                                <li>$graphLookup</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Aggregation Pipeline Example</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-39|1-2|3|4-38|4-8|9-16|17-33|34-38">
                                    db
                                        .getCollection("movies")
                                        .aggregate([
                                        {
                                          $match: {
                                            directors: "Quentin Tarantino",
                                          },
                                        },
                                        {
                                          $lookup: {
                                            from: "comments",
                                            foreignField: "movie_id",
                                            localField: "_id",
                                            as: "comments",
                                          },
                                        },
                                        {
                                          $group: {
                                            _id: {
                                              $year: "$released",
                                            },
                                            movies: {
                                              $push: {
                                                _id: "$_id",
                                                title: "$title",
                                                cast: "$cast",
                                                released: "$released",
                                                comments: { $slice: [ "$comments", 5 ] },
                                                commentCount: { $size: "$comments" } ]
                                              },
                                            },
                                          },
                                        },
                                        {
                                          $sort: {
                                            _id: 1,
                                          },
                                        },
                                      ]);
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="aggregationPipeline_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="aggregationPipeline">Clear</button>
                            <button class="runDemoButton" data-demo-name="aggregationPipeline">Run</button>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Streaming vs Blocking</h3>

                    <ul>
                        <li>Most stages are <em>streaming</em></li>
                        <li>Grouping and counting stages are <em>blocking</em></li>
                    </ul>
                </section>
            </section>

            <section>
                <section>
                    <h2>Explain Plans</h2>

                    <ul>
                        <li class="fragment">Explain how the query engine will locate documents</li>
                        <li class="fragment">Available for "classic" queries and pipelines</li>
                    </ul>
                </section>

                <section>
                    <h3>Explain Plan Example</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-4|1-2|3|4">
                                    db
                                        .getCollection("movies")
                                        .find({ directors: "Quentin Tarantino" })
                                        .explain()
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="explainPlan_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="explainPlan">Clear</button>
                            <button class="runDemoButton" data-demo-name="explainPlan">Run</button>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Explain Aggregation Plan Example</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-8|1-2|3-7|8">
                                    db
                                        .getCollection("movies")
                                        .aggregate([
                                            { $match: {
                                                directors: "Quentin Tarantino" }
                                            }
                                        ])
                                        .explain()
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="explainAggregationPlan_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="explainAggregationPlan">Clear</button>
                            <button class="runDemoButton" data-demo-name="explainAggregationPlan">Run</button>
                        </div>
                    </div>
                </section>
            </section>

            <section>
                <section>
                    <h2>Indexes</h2>

                    <ul>
                        <li class="fragment">Allow more efficient queries</li>
                        <li class="fragment">_id is the primary key</li>
                    </ul>
                </section>

                <section>
                    <h3>Types of indexes</h3>

                    <ul>
                        <li>Single field</li>
                        <li>Compound</li>
                        <li>Multikey</li>
                        <li>Text</li>
                        <li>Wildcard</li>
                        <li>Geospatial</li>
                    </ul>
                </section>

                <section>
                    <h3>Creating and Using Indexes</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-16|4-6|9-16">
                                    // Create a multikey index
                                    db
                                        .getCollection("movies")
                                        .createIndex({
                                            "directors": 1
                                        })

                                    // Explain Aggregation Plan
                                    db
                                        .getCollection("movies")
                                        .aggregate([
                                            { $match: {
                                                directors: "Quentin Tarantino" }
                                            }
                                        ])
                                        .explain()
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="multikeyIndex_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="multikeyIndex">Clear</button>
                            <button class="runDemoButton" data-demo-name="multikeyIndex">Run</button>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>
                        Hiding Indexes
                    </h3>

                    <ul>
                        <li>"Deactivates" indexes without removing index data</li>
                        <li>Allows restoring the index without rebuilding</li>
                    </ul>
                </section>

                <section>
                    <h3>Hiding Indexes</h3>

                    <div class="demo-columns">
                        <div class="example">
                            <pre>
                                <code class="javascript" data-trim data-noescape data-line-numbers="1-16|4-6|9-16">
                                    // Hide the index
                                    db
                                        .getCollection("movies")
                                        .hideIndex("directors_1")

                                    // Explain Aggregation Plan
                                    db
                                        .getCollection("movies")
                                        .aggregate([
                                            { $match: {
                                                directors: "Quentin Tarantino" }
                                            }
                                        ])
                                        .explain()
                                </code>
                            </pre>
                        </div>

                        <div class="output">
                            <pre>
                                <code id="hideIndex_output" class="json" data-trim data-noescape>
                                </code>
                            </pre>
                        </div>

                        <div class="fragment fade-in example-controls">
                            <button class="clearDemoButton" data-demo-name="hideIndex">Clear</button>
                            <button class="runDemoButton" data-demo-name="hideIndex">Run</button>
                        </div>
                    </div>
                </section>
            </section>

            <section>
                <section>
                    <h2>Document Patterns</h2>
                </section>

                <!--
                    * Bucket Pattern
                    * Polymorphic Pattern
                    * Attribute Pattern
                    * Outlier Pattern
                    * Schema Versioning Pattern
                -->
            </section>

            <section>
                <section>
                    <h2>Transactions</h2>
                </section>
            </section>
        </div>
    </div>
</body>

</html>